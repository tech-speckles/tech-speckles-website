<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Column Cleaner — Billing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PayPal JS SDK: production client-id -->
  <script src="https://www.paypal.com/sdk/js?client-id=AQ82RXGFlVlFt1cy74T1QMDBm3lIhnFrzIBpqFFqGuxjiSvmXLkfjQmiUqioQtILYGiaBMtI26KHIYSw&vault=true&intent=subscription" /*data-sdk-integration-source="button-factory"*/ defer></script>

  <!-- Shared site styles -->
  <link rel="stylesheet" href="/assets/site.css" />
  <link rel="stylesheet" href="/smart-column-cleaner/style.css" />

  <style>
    :root{
      --ring:#e5e7eb; --muted:#666; --ok:#026e2d; --okbg:#e8f7ee; --chip:#f3f4f6; --chipbd:#e5e7eb;
      --accent:#0a7d2e;
    }
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:780px;margin:24px auto;padding:0 16px}
    header .brand-link{display:flex;align-items:center;gap:10px;text-decoration:none}
    .card{border:1px solid #eee;border-radius:12px;padding:16px;margin:16px 0;background:#fff}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .small{font-size:.9rem}
    .pill{font-size:.85rem;padding:2px 10px;border-radius:999px;border:1px solid var(--chipbd);background:var(--chip);color:#374151}
    .pill.pro{background:var(--okbg);border-color:#b6e5c6;color:var(--ok)}
    .pill.free{background:var(--chip)}
    button{padding:.6rem 1rem;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    #paypal-wrapper[hidden]{display:none}

    .pro-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .meta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .price{color:#333;font-weight:600}
    .as-link{text-decoration:underline}

    /* Plans grid */
    .plans{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media (min-width:640px){ .plans{grid-template-columns:1fr 1fr} }
    .plan{border:1px solid var(--ring);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start}
    .plan input[type="radio"]{accent-color:var(--accent);margin-top:5px}
    .plan h3{margin:0 0 6px 0;font-size:1rem}
    .badge{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:999px;background:#eef7ff;border:1px solid #cfe7ff;color:#0b57d0;margin-left:8px}
    .save{font-size:.85rem;color:#0b57d0;margin-left:6px}
    .dim{opacity:.7}

    .sandbox-flag{font-size:.8rem;border:1px dashed #bbb;border-radius:6px;padding:4px 8px;background:#fafafa}
  </style>
</head>
<body>

  <header>
    <div class="wrap brand">
      <a href="/" aria-label="Back to Tech Speckles home" class="brand-link">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color: var(--accent)">
          <circle cx="12" cy="12" r="10" fill="currentColor" opacity=".12"/>
          <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>Tech Speckles</h1>
      </a>
      <nav class="row">
        <a href="/smart-column-cleaner/help.html">Help</a>
        <a href="/smart-column-cleaner/support.html">Support</a>
        <a href="/smart-column-cleaner/privacy.html">Privacy</a>
        <a href="/smart-column-cleaner/tos.html">Terms</a>
      </nav>
    </div>
  </header>

  <h1>Smart Column Cleaner — Billing</h1>

  <!-- Sign-in card -->
  <div class="card">
    <div class="row">
      <span id="auth-state" class="muted">Not signed in</span>
      <button id="signin">Sign in with Google</button>
      <button id="signout" style="display:none">Sign out</button>
    </div>
    <div id="user-info" class="muted small"></div>
  </div>

  <!-- Subscription status + actions -->
  <div class="card" id="pro-card">
    <div class="pro-head">
      <h2 style="margin:0">Subscription</h2>
      <div class="meta">
        <span id="status" class="pill free" aria-live="polite">Status: checking…</span>
        <a id="refreshLink" class="as-link small" href="#" aria-label="Refresh status">Refresh</a>
        <a id="manageLink" class="as-link small" href="https://www.paypal.com/myaccount/autopay/" target="_blank" rel="noopener" hidden>Manage on PayPal</a>
      </div>
    </div>
    <div id="next-bill" class="muted small" aria-live="polite" style="margin-top:4px"></div>

    <ul class="small" style="margin-top:12px">
      <li>Pro = <strong>Unlimited cells</strong> (Free is 300/day).</li>
      <li>Cancel anytime in PayPal; access continues until the end of your paid period + grace.</li>
      <li>No sheet data leaves your Google account.</li>
    </ul>

    <!-- Always-visible plan cards (selection drives the PayPal button below) -->
    <section aria-labelledby="choose-plan-title" style="margin-top:8px">
      <h3 id="choose-plan-title" class="small muted" style="margin:0 0 6px">Choose your plan</h3>

      <div class="plans" role="radiogroup" aria-label="Plans">
        <label class="plan" for="plan-monthly">
          <input type="radio" name="plan" id="plan-monthly" value="monthly" />
          <div>
            <h3>Pro Monthly <span class="price" id="p-month"></span></h3>
            <div class="muted small" id="p-month-note">Renews every month. Cancel anytime.</div>
          </div>
        </label>

        <label class="plan" for="plan-yearly">
          <input type="radio" name="plan" id="plan-yearly" value="yearly" />
          <div>
            <h3>Pro Yearly <span class="badge">Best value</span> <span class="price" id="p-year"></span></h3>
            <div class="muted small" id="p-year-note">Renews every year. Cancel anytime. <span class="save" id="p-save"></span></div>
          </div>
        </label>
      </div>

      <p class="small muted" id="plan-hint" style="margin-top:8px"></p>
    </section>

    <!-- Actions -->
    <div id="paypal-wrapper" hidden style="margin-top:8px">
      <div id="paypal-button-container"></div>
      <p class="muted small" id="post-approve" style="display:none;margin-top:8px">
        Thanks! Activating your license… this usually takes under a minute. If not updated, click <strong>Refresh</strong>.
      </p>
    </div>
    <p id="signin-hint" class="muted small" style="margin-top:6px;display:none">
      Please sign in to continue with PayPal.
    </p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    // Firebase config (public)
    const firebaseConfig = {
      apiKey: "AIzaSyAB6FwjjGUHgEzzvKWBEUhGuKSw2EqxgsY",
      authDomain: "smart-column-cleaner.firebaseapp.com",
      projectId: "smart-column-cleaner",
      storageBucket: "smart-column-cleaner.firebasestorage.app",
      messagingSenderId: "811367949945",
      appId: "1:811367949945:web:738a1cf1aefc4c670716a8",
      measurementId: "G-JDGM6N0KTX"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // DOM refs
    const signinBtn   = document.getElementById('signin');
    const signoutBtn  = document.getElementById('signout');
    const authState   = document.getElementById('auth-state');
    const userInfo    = document.getElementById('user-info');
    const statusEl    = document.getElementById('status');
    const refreshLink = document.getElementById('refreshLink');
    const manageLink  = document.getElementById('manageLink');
    const nextBill    = document.getElementById('next-bill');
    const planHint    = document.getElementById('plan-hint');
    const signinHint  = document.getElementById('signin-hint');
    const ppWrap      = document.getElementById('paypal-wrapper');
    const postApprove = document.getElementById('post-approve');
    const paypalContainer = document.getElementById('paypal-button-container');

    const pMonth = document.getElementById('p-month');
    const pYear  = document.getElementById('p-year');
    const pYearSave = document.getElementById('p-save');
    const pMonthNote = document.getElementById('p-month-note');
    const pYearNote  = document.getElementById('p-year-note');

    const planMonthlyRadio = document.getElementById('plan-monthly');
    const planYearlyRadio  = document.getElementById('plan-yearly');

    // Functions URL
    const GET_LICENSE_URL = "https://getlicense-2dsvjh67hq-uc.a.run.app";

    // LIVE plan IDs
    const PLAN_ID_MONTHLY = 'P-84T73598XH0604549NDLXLII';
    const PLAN_ID_YEARLY  = 'P-1HR93549KG238334SNDQTFCQ';

    // Price labels (adjust if you change pricing)
    const PRICE_MONTHLY = "$2.99 / month";
    const PRICE_YEARLY  = "$19 / year";

    // Return/cancel URLs
    const RETURN_URL = "https://techspeckles.com/smart-column-cleaner/success.html";
    const CANCEL_URL = "https://techspeckles.com/smart-column-cleaner/cancel.html";

    // --- Helpers
    function parseUSD(str){
      // "$2.99 / month" -> 2.99
      const m = String(str).match(/([\d.]+)/);
      return m ? parseFloat(m[1]) : NaN;
    }
    function computeYearlySavings(monthlyStr, yearlyStr){
      const m = parseUSD(monthlyStr);
      const y = parseUSD(yearlyStr);
      if (!isFinite(m) || !isFinite(y)) return { pct: null, perMonthEq: null };
      const yearlyAtMonthly = m * 12;
      const pct = Math.max(0, Math.round((1 - (y / yearlyAtMonthly)) * 100));
      const perMonthEq = (y / 12).toFixed(2);
      return { pct, perMonthEq };
    }
    function selectedPlanId(){
      return planYearlyRadio.checked ? PLAN_ID_YEARLY : PLAN_ID_MONTHLY;
    }
    function preferYearlyDefault(){
      // default Yearly selected (nudge); change to monthly if you prefer
      planYearlyRadio.checked = true;
    }
    function setPlanDisplay(){
      pMonth.textContent = PRICE_MONTHLY;
      pYear.textContent  = PRICE_YEARLY;
      const { pct, perMonthEq } = computeYearlySavings(PRICE_MONTHLY, PRICE_YEARLY);
      pYearSave.textContent = isFinite(pct) ? `Save ${pct}% vs monthly` : '';
      if (perMonthEq) pYearNote.title = `≈ $${perMonthEq}/month effective`;
      pMonthNote.title = "Billed monthly";
    }

    async function onPaypalReady(maxWaitMs = 6000){
      if (window.paypal) return;
      const start = Date.now();
      await new Promise((resolve, reject) => {
        const t = setInterval(() => {
          if (window.paypal){ clearInterval(t); resolve(); }
          else if (Date.now() - start > maxWaitMs){ clearInterval(t); reject(new Error('PayPal SDK not ready')); }
        }, 150);
      });
    }

    function renderPaypalButtons(user){
      if (!user || !window.paypal) return;
      paypalContainer.innerHTML = '';
      window.paypal.Buttons({
        createSubscription: (data, actions) => actions.subscription.create({
          plan_id: selectedPlanId(),
          custom_id: user.uid,
          application_context: {
            return_url: RETURN_URL,
            cancel_url: CANCEL_URL,
            user_action: 'SUBSCRIBE_NOW'
          }
        }),
        onApprove: (data) => {
          console.log('Approved:', data);
          postApprove.style.display = 'block';
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('PayPal error: ' + err.message);
        }
      }).render('#paypal-button-container');
    }

    async function fetchLicense(user){
      if (!user) return { plan:'free' };
      const idToken = await user.getIdToken();
      const r = await fetch(GET_LICENSE_URL, { headers:{ Authorization:`Bearer ${idToken}` }});
      return r.ok ? r.json() : { plan:'free' };
    }

    async function refreshStatus(user){
      try{
        if (!user){
          statusEl.textContent = "Status: free (not signed in)";
          statusEl.className = "pill free";
          manageLink.hidden = true;
          nextBill.textContent = "";
          planHint.textContent = "Sign in to purchase. You’ll choose a plan and pay with PayPal.";
          signinHint.style.display = "block";
          ppWrap.hidden = true;
          return { plan:'free' };
        }

        const data = await fetchLicense(user);
        const plan      = String(data.plan || 'free').toLowerCase(); // 'free' | 'pro'
        const cadence   = String(data.planCadence || '').toLowerCase(); // 'monthly' | 'yearly' | ''
        const statusTxt = data.status || (plan === 'free' ? 'free' : 'active');
        const labelCad  = cadence ? ` — Pro (${cadence[0].toUpperCase()}${cadence.slice(1)})` : (plan !== 'free' ? ' — Pro' : '');
        statusEl.textContent = `Status: ${statusTxt}${labelCad}`;

        if (plan !== 'free'){
          statusEl.className = "pill pro";
          manageLink.hidden = false;
          signinHint.style.display = "none";
          if (data.periodEnd){
            const d = new Date(data.periodEnd);
            nextBill.textContent = `Next bill: ${d.toLocaleDateString()} (local time)`;
          } else {
            nextBill.textContent = "";
          }
          planHint.textContent = "Already Pro. To change plans, cancel in PayPal, then subscribe to the other plan.";
          ppWrap.hidden = true; // already Pro → hide payment UI
        } else {
          statusEl.className = "pill free";
          manageLink.hidden = true;
          nextBill.textContent = "";
          planHint.textContent = "You can switch plans any time later (cancel in PayPal, then subscribe to the other).";
          signinHint.style.display = "none";
          ppWrap.hidden = false; // Free + signed-in → show payment UI
          await onPaypalReady().catch(()=>{ /* ignore */ });
          renderPaypalButtons(user);
        }
        return data;
      } catch(e){
        console.error('Status error', e);
        statusEl.textContent = "Status: error while checking";
        statusEl.className = "pill free";
        manageLink.hidden = true;
        nextBill.textContent = "";
        signinHint.style.display = user ? "none" : "block";
        planHint.textContent = user ? "We couldn’t fetch your license. You can still subscribe—the license will activate automatically." : "Sign in to continue.";
        ppWrap.hidden = !user;
        return { plan:'free' };
      }
    }

    // Auth handlers
    signinBtn.onclick  = async () => {
      try { await signInWithPopup(auth, provider); }
      catch(e){
        if (e.code === 'auth/popup-blocked' || e.code === 'auth/cookie-policy'){
          await signInWithRedirect(auth, provider);
        } else {
          alert(`Sign-in failed: ${e.code}`);
          console.error('signInWithPopup error:', e.code, e.message);
        }
      }
    };
    signoutBtn.onclick = () => signOut(auth);

    refreshLink.onclick = async (e) => {
      e.preventDefault();
      await refreshStatus(auth.currentUser || null);
    };

    onAuthStateChanged(auth, async (user) => {
      preferYearlyDefault(); // default selection
      setPlanDisplay();

      if (user){
        authState.textContent = "Signed in";
        signinBtn.style.display = "none";
        signoutBtn.style.display = "inline-block";
        userInfo.textContent = `${user.displayName || user.email} — uid: ${user.uid}`;
        await refreshStatus(user);
      } else {
        authState.textContent = "Not signed in";
        signinBtn.style.display = "inline-block";
        signoutBtn.style.display = "none";
        userInfo.textContent = "";
        ppWrap.hidden = true;
        signinHint.style.display = "block";
        await refreshStatus(null);
      }
    });

    // Re-render PayPal buttons if Free & signed in when the plan selection changes
    document.addEventListener('change', async (ev) => {
      if (ev.target.name !== 'plan') return;
      const user = auth.currentUser;
      if (!user) return;
      const data = await fetchLicense(user);
      if (String(data.plan || 'free').toLowerCase() === 'free'){
        await onPaypalReady().catch(()=>{});
        renderPaypalButtons(user);
      }
    });
  </script>
</body>
</html>
