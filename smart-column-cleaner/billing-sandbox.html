<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Column Cleaner â€” Billing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PayPal JS SDK: Subscriptions require vault + intent=subscription -->
  <script src="https://www.paypal.com/sdk/js?client-id=AUm-VJJQZJmLkTIobeYIoNAGkIrGdvCxoSJkr5I36eROJXqgC1CecHwfMTag7CSvKQUSNM8YP7aDc6Xj&vault=true&intent=subscription" data-sdk-integration-source="button-factory" defer></script>

  <!-- Shared site styles -->
  <link rel="stylesheet" href="/assets/site.css" />
  <link rel="stylesheet" href="/smart-column-cleaner/style.css" />

  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:720px;margin:24px auto;padding:0 16px}
    .card{border:1px solid #eee;border-radius:12px;padding:16px;margin:16px 0}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:#666}
    button{padding:.6rem 1rem;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    #paypal-wrapper[hidden]{display:none}

    /* New: tidy header area inside Pro card */
    .pro-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .meta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .price{color:#333;font-size:.95rem}
    .pill{font-size:.85rem;padding:2px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f3f4f6;color:#374151}
    .pill.pro{background:#e8f7ee;border-color:#b6e5c6;color:#026e2d}
    .pill.free{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
    .meta a.as-link{font-size:.9rem;text-decoration:underline}
  </style>

</head>
<body>

  <header>
    <div class="wrap brand">
      <a href="/" aria-label="Back to Tech Speckles home" class="brand-link" style="display:flex;align-items:center;gap:10px;text-decoration:none">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color: var(--accent)">
          <circle cx="12" cy="12" r="10" fill="currentColor" opacity=".12"/>
          <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>Tech Speckles</h1>
      </a>
      <nav>
        <a href="/smart-column-cleaner/help.html">Help</a>
        <a href="/smart-column-cleaner/support.html">Support</a>
        <a href="/smart-column-cleaner/privacy.html">Privacy</a>
        <a href="/smart-column-cleaner/tos.html">Terms</a>
      </nav>
    </div>
  </header>

  <h1>Smart Column Cleaner â€” Billing</h1>

  <div class="card">
    <div class="row">
      <span id="auth-state" class="muted">Not signed in</span>
      <button id="signin">Sign in with Google</button>
      <button id="signout" style="display:none">Sign out</button>
    </div>
    <div id="user-info" class="muted"></div>
  </div>

  <div class="card" id="pro-card">
    <div class="pro-head">
      <h2 style="margin:0">Pro Subscription</h2>
      <div class="meta">
        <span class="price">USD monthly â€¢ cancel anytime.</span>
        <span id="status" class="pill free" aria-live="polite">Status: checkingâ€¦</span>
        <a id="manageLink" class="as-link" href="https://www.paypal.com/myaccount/autopay/" target="_blank" rel="noopener" hidden>Manage</a>
      </div>
    </div>

    <ul class="small" style="margin-top:12px">
      <li>Unlimited cells per day (Free is 300/day).</li>
      <li>Cancel anytime; changes take effect at next renewal.</li>
      <li>Data stays inside your Google account; we donâ€™t export your sheet data.</li>
    </ul>
    <p class="small muted" style="margin-top:8px">
      Need help? <a href="/smart-column-cleaner/support.html">Contact support</a>.
      Read our <a href="/smart-column-cleaner/privacy.html">Privacy</a> and <a href="/smart-column-cleaner/tos.html">Terms</a>.
    </p>

    <div id="paypal-wrapper" hidden>
      <div id="paypal-button-container"></div>
      <p class="muted" id="post-approve" style="display:none">
        Thanks! If you saw the PayPal approval screen, your license will activate after we receive the webhook.
      </p>
    </div>
  </div>

  <script type="module">
    // --- Firebase v9+ modular CDN (you can paste your v12 snippet as-is) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    // ðŸ”§ Paste your Firebase config here (public)
    const firebaseConfig = {
      apiKey: "AIzaSyAB6FwjjGUHgEzzvKWBEUhGuKSw2EqxgsY",
      authDomain: "smart-column-cleaner.firebaseapp.com",
      projectId: "smart-column-cleaner",
      storageBucket: "smart-column-cleaner.firebasestorage.app",
      messagingSenderId: "811367949945",
      appId: "1:811367949945:web:738a1cf1aefc4c670716a8",
      measurementId: "G-JDGM6N0KTX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const signinBtn  = document.getElementById('signin');
    const signoutBtn = document.getElementById('signout');
    const authState  = document.getElementById('auth-state');
    const userInfo   = document.getElementById('user-info');
    const statusEl   = document.getElementById('status');
    const ppWrap     = document.getElementById('paypal-wrapper');
    const postApprove= document.getElementById('post-approve');
    const manageLink = document.getElementById('manageLink');

    // Your deployed Cloud Function (getLicense)
    const GET_LICENSE_URL = "https://getlicense-2dsvjh67hq-uc.a.run.app";

    // Your PayPal plan id (sandbox) and return/cancel URLs
    const PLAN_ID = "P-5T418048NW3627742NDBCKGY";
    const RETURN_URL = "https://techspeckles.com/smart-column-cleaner/success.html";
    const CANCEL_URL = "https://techspeckles.com/smart-column-cleaner/cancel.html";

    async function refreshStatus(user) {
      try {
        if (!user) {
          statusEl.textContent = "Status: free (not signed in)";
          statusEl.className = "pill free";
          manageLink.hidden = true;
          // When not signed in, don't show PayPal yet (forces sign-in first)
          ppWrap.hidden = true;
          return;
        }
        console.log('user: ', user);
        const idToken = await user.getIdToken();
        const r = await fetch(GET_LICENSE_URL, { headers: { Authorization: `Bearer ${idToken}` }});
        const data = await r.json();
        console.log('License data: ', data);
        const plan = (data.plan || 'free').toLowerCase();
        const statusTxt = data.status || (plan === 'free' ? 'free' : 'active');
        statusEl.textContent = `Status: ${statusTxt} (${plan})`;

        if (plan !== 'free') {
          statusEl.className = "pill pro";
          manageLink.hidden = false;
          ppWrap.hidden = true;   // Hide PayPal button if already Pro
        } else {
          statusEl.className = "pill free";
          manageLink.hidden = true;
          ppWrap.hidden = false;  // Show button for Free users (once signed in)
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Status: error while checking";
        statusEl.className = "pill free";
        manageLink.hidden = true;
        // Keep PayPal visible so they can try to subscribe even if status check failed
        ppWrap.hidden = !user;
      }
    }


    signinBtn.onclick  = () => signInWithPopup(auth, provider); // Popup is fine on desktop. :contentReference[oaicite:2]{index=2}
    signoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authState.textContent = "Signed in";
        signinBtn.style.display = "none";
        signoutBtn.style.display = "inline-block";
        userInfo.textContent = `${user.displayName || user.email} â€” uid: ${user.uid}`;

        await refreshStatus(user);

        // Render PayPal buttons once (after SDK loads and user is known)
        if (window.paypal && !window.__ppRendered) {
          window.__ppRendered = true;
          paypal.Buttons({
            createSubscription: function (data, actions) {
              return actions.subscription.create({
                plan_id: PLAN_ID,
                custom_id: user.uid,
                application_context: {
                  return_url: RETURN_URL,
                  cancel_url: CANCEL_URL,
                  user_action: "SUBSCRIBE_NOW"
                }
              });
            },
            onApprove: function (data, actions) {
              console.log("Approved:", data);
              postApprove.style.display = "block";
              // Webhook will update Firestore; user can click "Refresh" by reloading or toggling auth.
            },
            onError: function (err) {
              console.error("PayPal error", err);
              alert("PayPal error: " + err);
            }
          }).render('#paypal-button-container');
        }

      } else {
        authState.textContent = "Not signed in";
        signinBtn.style.display = "inline-block";
        signoutBtn.style.display = "none";
        userInfo.textContent = "";
        await refreshStatus(null);
      }
    });

  </script>
</body>
</html>
