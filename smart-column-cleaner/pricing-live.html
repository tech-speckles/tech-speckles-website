<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Column Cleaner â€” Pricing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Pricing & subscription for Smart Column Cleaner." />

  <!-- PayPal JS SDK: Live client-id -->
  <script src="https://www.paypal.com/sdk/js?client-id=AQ82RXGFlVlFt1cy74T1QMDBm3lIhnFrzIBpqFFqGuxjiSvmXLkfjQmiUqioQtILYGiaBMtI26KHIYSw&vault=true&intent=subscription&disable-funding=card" defer></script>

  <!-- Shared site styles -->
  <link rel="stylesheet" href="/assets/site.css" />
  <link rel="stylesheet" href="/smart-column-cleaner/style.css" />
  <link rel="icon" type="image/png" sizes="48x48" href="/smart-column-cleaner/img/logo-48.png" />
  <link rel="icon" type="image/png" sizes="128x128" href="/smart-column-cleaner/img/logo-128.png" />
  <meta property="og:title" content="Pricing Â· Smart Column Cleaner" />
  <meta property="og:description" content="Get Pro â€” unlimited cells with easy PayPal subscription." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#14B8A6" />

  <!-- Page-local (scoped) styles for pricing UI only -->
  <style>
    /* Pills for status */
    .pill{font-size:.9rem;padding:2px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f3f4f6;color:#374151;display:inline-block}
    .pill.pro{background:#e8f7ee;border-color:#b6e5c6;color:#026e2d}
    .pill.free{background:#f3f4f6}

    /* Pricing cards/grid */
    .meta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .plans{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media (min-width:640px){ .plans{grid-template-columns:1fr 1fr} }

    .plan{border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start;background:#fff}
    .plan input[type="radio"]{accent-color:var(--accent);margin-top:5px}
    .plan h3{margin:0 0 6px 0;font-size:1rem}
    .price{color:#333;font-weight:600}
    .badge{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:999px;background:#eef7ff;border:1px solid #cfe7ff;color:#0b57d0;margin-left:8px}
    .save{font-size:.85rem;color:#0b57d0;margin-left:6px}

    /* Hideable wrapper */
    #paypal-wrapper[hidden]{display:none}

    /* Bottom CTA layout */
    .cta{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    /* small lock icon on CTA when paying */
    .icon-lock{
      display:inline-block; margin-left:6px; opacity:.85;
      transform: translateY(1px);
    }
    /* Billing country dropdown */
    #billing-country{
      display:block;
      width:100%;
      max-width:260px;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--border-subtle, #d0d7de);
      background-color:#fff;
      font-size:.9rem;
      line-height:1.3;
    }

    #billing-country:focus{
      outline:none;
      border-color:var(--accent, #0b57d0);
      box-shadow:0 0 0 2px rgba(11,87,208,.18);
    }

    /* Notify-me email input */
    #notify-email{
      display:block;
      width:100%;
      max-width:260px;
      box-sizing:border-box;
      margin-top:4px;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--border-subtle, #d0d7de);
      background-color:#fff;
      font-size:.9rem;
      line-height:1.3;
    }

    #notify-email::placeholder{
      color:#9ca3af; /* soft grey placeholder */
    }

    #notify-email:focus{
      outline:none;
      border-color:var(--accent, #0b57d0);
      box-shadow:0 0 0 2px rgba(11,87,208,.18);
    }

    /* When we mark it read-only after saving */
    #notify-email[readonly]{
      background-color:#f6f8fa;
      color:#4b5563;
      border-style:dashed;
    }

    @media (max-width: 640px){
      #notify-email{ max-width:100%; }
    }

  </style>
</head>
<body>
<a class="skip" href="#main">Skip to content</a>

<header>
  <div class="wrap brand">
    <a href="/" aria-label="Back to Tech Speckles home" class="brand-link" style="display:flex;align-items:center;gap:10px;text-decoration:none">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color: var(--accent)">
        <circle cx="12" cy="12" r="10" fill="currentColor" opacity=".12"/>
        <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h1>Tech Speckles</h1>
    </a>
    <nav>
      <a href="/smart-column-cleaner/pricing.html" aria-current="page">Pricing</a>
      <a href="/smart-column-cleaner/help.html">Help</a>
      <a href="/smart-column-cleaner/support.html">Support</a>
      <a href="/smart-column-cleaner/report-issue.html">Report issue</a>
      <a href="/smart-column-cleaner/privacy.html">Privacy</a>
      <a href="/smart-column-cleaner/tos.html">Terms</a>
    </nav>
  </div>
</header>

<main id="main" class="wrap">
  <nav aria-label="Breadcrumb" class="crumbs">
    <a href="/smart-column-cleaner/">Smart Column Cleaner</a>
    <span class="sep">/</span>
    <span aria-current="page">Pricing</span>
  </nav>
  <h1>Smart Column Cleaner â€” Pricing</h1>

  <!-- Sign-in card -->
  <!--div class="card" aria-labelledby="auth-title">
    <h2 id="auth-title" class="small" style="margin:0 0 8px">Account</h2>
    <div class="meta" style="margin-top:2px">
      <span id="auth-state" class="muted">Not signed in</span>
      <button id="signin" class="btn secondary" type="button">Sign in with Google</button>
      <button id="signout" class="btn secondary" type="button" style="display:none">Sign out</button>
    </div>
    <div id="user-info" class="muted" style="margin-top:6px"></div>
  </div-->

  <!-- Subscription status + actions -->
  <div class="card" id="pro-card" aria-labelledby="sub-title">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h2 id="sub-title" style="margin:0">Subscription</h2>
      <div class="meta">
        <span id="status" class="pill free" aria-live="polite">Status: checkingâ€¦</span>
        <a id="refreshLink" class="small" href="#" aria-label="Refresh status">Refresh</a>
        <a id="manageLink" class="small" href="https://www.paypal.com/myaccount/autopay/" target="_blank" rel="noopener" hidden>Manage on PayPal</a>
        <button id="signout" class="btn secondary" type="button" style="display:none">Sign out</button>
      </div>
      <div id="user-info" class="muted small" style="margin-top:4px"></div>

    </div>

    <div id="next-bill" class="muted small" aria-live="polite" style="margin-top:6px"></div>

    <ul class="small" style="margin-top:12px">
      <li>Pro = <strong>Unlimited cells</strong> (Free is 300/day).</li>
      <li>Cancel anytime in PayPal; access continues until the end of your paid period + grace.</li>
      <li>No sheet data leaves your Google account.</li>
    </ul>

    <!-- Plan chooser -->
    <section aria-labelledby="choose-plan-title" style="margin-top:8px">
      <h3 id="choose-plan-title" class="small muted" style="margin:0 0 6px">Choose your plan</h3>

      <div class="plans" role="radiogroup" aria-label="Plans">
        <label class="plan" for="plan-monthly">
          <input type="radio" name="plan" id="plan-monthly" value="monthly" />
          <div>
            <h3>Pro Monthly <span class="price" id="p-month"></span></h3>
            <div class="muted small" id="p-month-note">Renews every month. Cancel anytime.</div>
          </div>
        </label>

        <label class="plan" for="plan-yearly">
          <input type="radio" name="plan" id="plan-yearly" value="yearly" />
          <div>
            <h3>Pro Yearly <span class="badge">Best value</span> <span class="price" id="p-year"></span></h3>
            <div class="muted small" id="p-year-note">Renews every year. Cancel anytime. <span class="save" id="p-save"></span></div>
          </div>
        </label>
      </div>

      <p class="small muted" id="plan-hint" style="margin-top:8px"></p>
    </section>

    <!-- Billing country -->
    <section aria-labelledby="billing-country-title" style="margin-top:10px">
      <h3 id="billing-country-title" class="small muted" style="margin:0 0 6px">
        Where do you live?
      </h3>

      <select id="billing-country">
        <option value="">Select your countryâ€¦</option>

        <optgroup label="Commonly selected">
          <option value="US">United States</option>
          <option value="CA">Canada</option>
          <option value="AU">Australia</option>
          <option value="GB">United Kingdom</option>
          <option value="IN">India</option>
        </optgroup>

        <optgroup label="Europe (EU)">
          <option value="AT">Austria</option>
          <option value="BE">Belgium</option>
          <option value="BG">Bulgaria</option>
          <option value="HR">Croatia</option>
          <option value="CY">Cyprus</option>
          <option value="CZ">Czech Republic</option>
          <option value="DK">Denmark</option>
          <option value="EE">Estonia</option>
          <option value="FI">Finland</option>
          <option value="FR">France</option>
          <option value="DE">Germany</option>
          <option value="GR">Greece</option>
          <option value="HU">Hungary</option>
          <option value="IE">Ireland</option>
          <option value="IT">Italy</option>
          <option value="LV">Latvia</option>
          <option value="LT">Lithuania</option>
          <option value="LU">Luxembourg</option>
          <option value="MT">Malta</option>
          <option value="NL">Netherlands</option>
          <option value="PL">Poland</option>
          <option value="PT">Portugal</option>
          <option value="RO">Romania</option>
          <option value="SK">Slovakia</option>
          <option value="SI">Slovenia</option>
          <option value="ES">Spain</option>
          <option value="SE">Sweden</option>
        </optgroup>

        <optgroup label="Other">
          <option value="OTHER">Other / not listed</option>
        </optgroup>
      </select>

      <p id="country-hint" class="small muted" style="margin-top:6px">
        We only use this to choose the right billing flow. Your Sheets data is not affected.
      </p>
    </section>

    <!-- Bottom CTA (shows a single clear next step) -->
    <div id="bottom-cta" class="card small" style="margin-top:10px; padding:10px; display:none">
      <div class="cta">
        <div>
          <strong id="cta-msg">Sign in to purchase with PayPal.</strong>
          <div class="muted" id="cta-sub" style="margin-top:4px">
            Youâ€™ll choose a plan above and pay securely on PayPal.
          </div>

          <!-- NEW: notify-me email area (shown only for blocked countries) -->
          <div id="notify-wrapper" style="margin-top:8px; display:none">
            <!--label for="notify-email" class="small">
              Leave your email and weâ€™ll notify you when Pro is available in your country.
            </label-->
            <input
              id="notify-email"
              type="email"
              placeholder="you@example.com"
            />
            <div id="notify-hint" class="small muted" style="margin-top:4px">
              Weâ€™ll only use this to notify you about Smart Column Cleaner Pro availability.
            </div>
          </div>
          <!-- END notify wrapper -->

        </div>
        <button id="cta-btn" class="btn primary" type="button" data-action="signin">Sign in &amp; continue</button>
      </div>
    </div>

    <!-- PayPal actions -->
    <div id="paypal-wrapper" hidden style="margin-top:8px">
      <div id="paypal-button-container"></div>
      <p class="muted small" id="post-approve" style="display:none;margin-top:8px">
        Thanks! Activating your licenseâ€¦ this usually takes under a minute. If not updated, click <strong>Refresh</strong>.
      </p>
    </div>

  </div>
</main>

<footer>
  <div class="wrap small">
    Â© <span id="y"></span> Tech Speckles. All rights reserved. Â·
    <a href="/smart-column-cleaner/privacy.html">Privacy</a> Â·
    <a href="/smart-column-cleaner/tos.html">Terms</a>
  </div>
</footer>

<script>document.getElementById('y').textContent=new Date().getFullYear()</script>

<!-- App logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  // Firebase config (public)
  const firebaseConfig = {
    apiKey: "AIzaSyAB6FwjjGUHgEzzvKWBEUhGuKSw2EqxgsY",
    authDomain: "smart-column-cleaner.firebaseapp.com",
    projectId: "smart-column-cleaner",
    storageBucket: "smart-column-cleaner.firebasestorage.app",
    messagingSenderId: "811367949945",
    appId: "1:811367949945:web:738a1cf1aefc4c670716a8",
    measurementId: "G-JDGM6N0KTX"
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // DOM refs (top Account card is optional/absent now)
  const signinBtn   = document.getElementById('signin') || null;
  const signoutBtn  = document.getElementById('signout') || null;
  const authState   = document.getElementById('auth-state') || null;
  const userInfo    = document.getElementById('user-info') || null;

  const statusEl    = document.getElementById('status');
  const refreshLink = document.getElementById('refreshLink');
  const manageLink  = document.getElementById('manageLink');
  const nextBill    = document.getElementById('next-bill');
  const planHint    = document.getElementById('plan-hint');
  const ppWrap      = document.getElementById('paypal-wrapper');
  const postApprove = document.getElementById('post-approve');
  const paypalContainer = document.getElementById('paypal-button-container');

  const pMonth = document.getElementById('p-month');
  const pYear  = document.getElementById('p-year');
  const pYearSave = document.getElementById('p-save');
  const pMonthNote = document.getElementById('p-month-note');
  const pYearNote  = document.getElementById('p-year-note');

  const planMonthlyRadio = document.getElementById('plan-monthly');
  const planYearlyRadio  = document.getElementById('plan-yearly');

  // Billing country refs
  const countrySelect = document.getElementById('billing-country');
  const countryHint   = document.getElementById('country-hint');

  let currentBillingCountry = '';

  function getBillingCountry() {
    if (!countrySelect) return '';
    return currentBillingCountry || countrySelect.value || '';
  }

  // Basic EU list (ISO country codes)
  const EU_COUNTRIES = new Set([
    'AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR',
    'HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK',
    'SI','ES','SE'
  ]);

  // Compute region from chosen country
  function getBillingRegion() {
    const c = (getBillingCountry() || '').toUpperCase();
    if (!c) return 'UNKNOWN';
    if (c === 'GB' || c === 'UK') return 'UK';
    if (c === 'IN') return 'IN';
    if (EU_COUNTRIES.has(c)) return 'EU';
    return 'ROW'; // Rest of world
  }

  function isBlockedRegion(region) {
    return region === 'EU' || region === 'UK' || region === 'IN';
  }

  if (countrySelect) {
    countrySelect.addEventListener('change', () => {
      currentBillingCountry = countrySelect.value || '';
      const region = getBillingRegion();
      console.log('[SCC pricing] Billing country set to:', currentBillingCountry || '(none)', 'â†’ region:', region);
      // Re-evaluate status whenever country changes
      const user = auth.currentUser || null;
      refreshStatus(user).catch(err => {
        console.error('[SCC pricing] refreshStatus failed after country change:', err);
      });
    });
  }

  // Bottom CTA refs
  const bottomCta  = document.getElementById('bottom-cta');
  const ctaMsg     = document.getElementById('cta-msg');
  const ctaSub     = document.getElementById('cta-sub');
  const ctaBtn     = document.getElementById('cta-btn');

  // NEW: notify-me refs
  const notifyWrapper    = document.getElementById('notify-wrapper');
  const notifyEmailInput = document.getElementById('notify-email');
  const notifyHint       = document.getElementById('notify-hint');

  function getNotifyEmail(user) {
    // Prefer what user typed, fall back to signed-in email
    if (notifyEmailInput && notifyEmailInput.value && notifyEmailInput.value.trim()) {
      return notifyEmailInput.value.trim();
    }
    if (user && user.email) return user.email;
    return '';
  }

  // Functions URL
  const GET_LICENSE_URL  = "https://getlicense-2dsvjh67hq-uc.a.run.app";
  const LOG_INTEREST_URL = "https://us-central1-smart-column-cleaner.cloudfunctions.net/logPurchaseInterest";
  // LIVE plan IDs
  const PLAN_ID_MONTHLY = 'P-84T73598XH0604549NDLXLII';
  const PLAN_ID_YEARLY  = 'P-1HR93549KG238334SNDQTFCQ';

  // Price labels (adjust if you change pricing)
  const PRICE_MONTHLY = "$2.99 / month";
  const PRICE_YEARLY  = "$19 / year";

  // Return/cancel URLs
  const RETURN_URL = "https://techspeckles.com/smart-column-cleaner/success.html";
  const CANCEL_URL = "https://techspeckles.com/smart-column-cleaner/cancel.html";

  // --- Helpers
  function parseUSD(str){
    // "$2.99 / month" -> 2.99
    const m = String(str).match(/([\d.]+)/);
    return m ? parseFloat(m[1]) : NaN;
  }
  function computeYearlySavings(monthlyStr, yearlyStr){
    const m = parseUSD(monthlyStr);
    const y = parseUSD(yearlyStr);
    if (!isFinite(m) || !isFinite(y)) return { pct: null, perMonthEq: null };
    const yearlyAtMonthly = m * 12;
    const pct = Math.max(0, Math.round((1 - (y / yearlyAtMonthly)) * 100));
    const perMonthEq = (y / 12).toFixed(2);
    return { pct, perMonthEq };
  }
  function selectedPlanId(){
    return planYearlyRadio.checked ? PLAN_ID_YEARLY : PLAN_ID_MONTHLY;
  }
  // Render identity line: default shows a button; click reveals UID inline
  function renderUserInfo(user, opts = {}) {
    if (!userInfo) return;
    const showUid = !!opts.showUid;
    const name = user.displayName || user.email || user.uid;
    if (showUid) {
      userInfo.textContent = `${name} â€” uid: ${user.uid}`;
    } else {
      userInfo.innerHTML =
        `${name} <button id="show-uid" class="btn secondary" type="button" style="margin-left:8px">Show UID</button>`;
      const btn = document.getElementById('show-uid');
      btn && btn.addEventListener('click', () => renderUserInfo(user, { showUid: true }));
    }
  }
  function preferYearlyDefault(){
    // default Yearly selected (nudge); change to monthly if you prefer
    planYearlyRadio.checked = true;
  }
  function setPlanDisplay(){
    pMonth.textContent = PRICE_MONTHLY;
    pYear.textContent  = PRICE_YEARLY;
    const { pct, perMonthEq } = computeYearlySavings(PRICE_MONTHLY, PRICE_YEARLY);
    pYearSave.textContent = isFinite(pct) ? `Save ${pct}% vs monthly` : '';
    if (perMonthEq) pYearNote.title = `â‰ˆ $${perMonthEq}/month effective`;
    pMonthNote.title = "Billed monthly";
  }

  async function onPaypalReady(maxWaitMs = 6000){
    if (window.paypal) return;
    const start = Date.now();
    await new Promise((resolve, reject) => {
      const t = setInterval(() => {
        if (window.paypal){ clearInterval(t); resolve(); }
        else if (Date.now() - start > maxWaitMs){ clearInterval(t); reject(new Error('PayPal SDK not ready')); }
      }, 150);
    });
  }

  function renderPaypalButtons(user){
    if (!user || !window.paypal) return;
    paypalContainer.innerHTML = '';
    window.paypal.Buttons({
      createSubscription: (data, actions) => actions.subscription.create({
        plan_id: selectedPlanId(),
        custom_id: user.uid,
        application_context: {
          return_url: RETURN_URL,
          cancel_url: CANCEL_URL,
          user_action: 'SUBSCRIBE_NOW'
        }
      }),
      onApprove: (data) => {
        console.log('Approved:', data);
        postApprove.style.display = 'block';
      },
      onError: (err) => {
        console.error('PayPal error', err);
        alert('PayPal error: ' + err.message);
      }
    }).render('#paypal-button-container');
  }

  async function fetchLicense(user){
    if (!user) return { plan:'free' };
    const idToken = await user.getIdToken();
    const r = await fetch(GET_LICENSE_URL, { headers:{ Authorization:`Bearer ${idToken}` }});
    return r.ok ? r.json() : { plan:'free' };
  }

  // One clear CTA at the bottom
  function showBottomCta({ visible, action, msg, sub, btnText }){
    bottomCta.style.display = visible ? 'block' : 'none';
    if (!visible) return;

    const isPay    = action === 'pay';
    const isNotify = action === 'notify';

    ctaBtn.dataset.action = action;     // 'signin' | 'pay' | 'manage' | 'notify'

    // Button label
    if (isPay) {
      ctaBtn.innerHTML = (btnText || 'Continue to PayPal') +
        ' <span class="icon-lock" aria-hidden="true">ðŸ”’</span>';
    } else {
      ctaBtn.textContent = btnText || (isNotify ? 'Notify me' : 'Continue');
    }

    ctaMsg.textContent = msg || '';
    ctaSub.textContent = sub || '';

    // Show/hide notify area
    if (notifyWrapper) {
      notifyWrapper.style.display = isNotify ? 'block' : 'none';
    }
  }


  async function refreshStatus(user){
    try{
      // Always show a neutral plan hint (no mixed sign-in text)
      const setNeutralPlanHint = () => {
        const { pct } = computeYearlySavings(PRICE_MONTHLY, PRICE_YEARLY);
        planHint.textContent = isFinite(pct) && pct > 0
          ? `Tip: Yearly saves about ${pct}% vs monthly.`
          : `Select a plan to continue.`;
      };

      const country    = (typeof getBillingCountry === 'function') ? getBillingCountry() : '';
      const hasCountry = !!country;
      const region     = hasCountry ? getBillingRegion() : 'UNKNOWN';
      const blocked    = hasCountry && isBlockedRegion(region);

      console.log('[SCC pricing] refreshStatus country:', country || '(none)', 'region:', region, 'blocked:', blocked);

      if (!user){
        // Signed in & Free
        statusEl.textContent = "Status: free (not signed in)";
        statusEl.className = "pill free";
        nextBill.textContent = "";
        setNeutralPlanHint();

        if (!hasCountry) {
          // Country not selected yet â†’ hide PayPal and ask for country
          ppWrap.hidden = true;
          showBottomCta({
            visible: true,
            action: 'country',
            msg: "Select your country to continue.",
            sub: "We only use this to choose the right billing flow. Your Sheets data is not affected.",
            btnText: "Select your country"
          });
        } else if (blocked) {
          // Blocked regions: no PayPal, show notify CTA
          ppWrap.hidden = true;
          showBottomCta({
            visible: true,
            action: 'signin',
            msg: "Pro purchases arenâ€™t available in your country yet.",
            sub: "Leave your email below and weâ€™ll notify you when billing is ready for your country.",
            btnText: "Sign in & notify me"
          });
        } else {
          // Allowed regions: normal PayPal flow
          ppWrap.hidden = false;
          await onPaypalReady().catch(()=>{});
          renderPaypalButtons(user);

          showBottomCta({
            visible: true,
            action: 'signin',
            msg: "Sign in to purchase with PayPal.",
            sub: "Youâ€™ll choose a plan above and pay securely on PayPal.",
            btnText: "Sign in & continue"
          });
        }

        return { plan:'free' };

      }


      // Signed in â†’ check license
      const data    = await fetchLicense(user);
      const plan    = String(data.plan || 'free').toLowerCase();   // 'free' | 'pro'
      const cadence = String(data.planCadence || '').toLowerCase();
      const statusTxt = data.status || (plan === 'free' ? 'free' : 'active');
      const labelCad  = cadence ? ` â€” Pro (${cadence[0].toUpperCase()}${cadence.slice(1)})` : (plan !== 'free' ? ' â€” Pro' : '');
      statusEl.textContent = `Status: ${statusTxt}${labelCad}`;

      if (plan !== 'free'){
        // Already Pro
        statusEl.className   = "pill pro";
        manageLink.hidden    = false;
        nextBill.textContent = data.periodEnd
          ? `Next bill: ${new Date(data.periodEnd).toLocaleDateString()} (local time)`
          : "";

        planHint.textContent = "Already Pro. To change plans, cancel in PayPal, then subscribe to the other plan.";
        // Blocked regions: no PayPal, show notify CTA
        ppWrap.hidden = true;
        showBottomCta({
          visible: true,
          action: 'notify',
          msg: "Pro purchases arenâ€™t available in your country yet.",
          sub: "Leave your email below and weâ€™ll notify you when billing is ready for your country.",
          btnText: "Notify me"
        });
        return data;
      }

      // Signed in & Free
      statusEl.className = "pill free";
      nextBill.textContent = "";
      setNeutralPlanHint();

      if (!hasCountry) {
        // Country not selected yet â†’ require it before anything else
        ppWrap.hidden = true;
        showBottomCta({
          visible: true,
          action: 'country',
          msg: "Select your country to continue.",
          sub: "We only use this to choose the right billing flow. Your Sheets data is not affected.",
          btnText: "Select your country"
        });
      } else if (blocked) {
        // Blocked regions: no PayPal, show info-only CTA
        ppWrap.hidden = true;
        showBottomCta({
          visible: true,
          action: 'notify',
          msg: "Pro purchases arenâ€™t available in your country yet.",
          sub: "Leave your email below and weâ€™ll notify you when billing is ready for your country.",
          btnText: "Notify me"
        });
      } else {
        // Allowed regions: normal PayPal flow
        ppWrap.hidden = false;
        await onPaypalReady().catch(()=>{});
        renderPaypalButtons(user);

        showBottomCta({
          visible: true,
          action: 'pay',
          msg: "Youâ€™re signed in.",
          sub: "Click continue to subscribe with PayPal.",
          btnText: "Continue to PayPal"
        });
      }

      return { plan:'free' };
 
    } catch(e){
      console.error('Status error', e);
      statusEl.textContent = "Status: error while checking";
      statusEl.className   = "pill free";
      manageLink.hidden    = true;
      nextBill.textContent = "";

      // In error state, keep things actionable
      planHint.textContent = "Select a plan to continue.";
      const isSignedIn = !!user;
      ppWrap.hidden = !isSignedIn;
      if (isSignedIn) {
        await onPaypalReady().catch(()=>{});
        renderPaypalButtons(user);
        showBottomCta({
          visible: true,
          action: 'pay',
          msg: "Youâ€™re signed in.",
          sub: "Click continue to subscribe with PayPal.",
          btnText: "Continue to PayPal"
        });
      } else {
        showBottomCta({
          visible: true,
          action: 'signin',
          msg: "Sign in to purchase with PayPal.",
          sub: "Youâ€™ll choose a plan above and pay securely on PayPal.",
          btnText: "Sign in & continue"
        });
      }
      return { plan:'free' };
    }
  }

  // Auth handlers
  if (signinBtn) {
    signinBtn.onclick = async () => {
      try { await signInWithPopup(auth, provider); }
      catch(e){
        if (e.code === 'auth/popup-blocked' || e.code === 'auth/cookie-policy'){
          await signInWithRedirect(auth, provider);
        } else {
          alert(`Sign-in failed: ${e.code}`);
          console.error('signInWithPopup error:', e.code, e.message);
        }
      }
    };
  }

  if (signoutBtn) {
    signoutBtn.onclick = () => signOut(auth);
  }

  refreshLink.onclick = async (e) => {
    e.preventDefault();
    await refreshStatus(auth.currentUser || null);
  };

  onAuthStateChanged(auth, async (user) => {
    preferYearlyDefault(); // default selection
    setPlanDisplay();

    if (user){
      // Top card may be absent
      if (authState)  authState.textContent = "Signed in";
      if (signinBtn)  signinBtn.style.display = "none";
      if (signoutBtn) signoutBtn.style.display = "inline-block";
      // if (userInfo)   userInfo.textContent = `${user.displayName || user.email} â€” uid: ${user.uid}`;
      renderUserInfo(user, { showUid: false });

      if (notifyEmailInput && !notifyEmailInput.value) {
        notifyEmailInput.value = user.email || '';
      }
      await refreshStatus(user);
    } else {
      if (authState)  authState.textContent = "Not signed in";
      if (signinBtn)  signinBtn.style.display = "inline-block";
      if (signoutBtn) signoutBtn.style.display = "none";
      if (userInfo)   userInfo.textContent = "";

      if (notifyEmailInput) notifyEmailInput.value = '';

      await refreshStatus(null);
    }
  });

  // Bottom CTA actions
  ctaBtn.onclick = async () => {
    const act = ctaBtn.dataset.action;
    if (act === 'signin') {
      try { await signInWithPopup(auth, provider); }
      catch(e){
        if (e.code === 'auth/popup-blocked' || e.code === 'auth/cookie-policy'){
          await signInWithRedirect(auth, provider);
        } else {
          alert(`Sign-in failed: ${e.code}`);
          console.error('signIn error:', e);
        }
      }
      return;
    }
    if (act === 'manage') {
      document.getElementById('manageLink').click();
      return;
    }
    if (act === 'pay') {
      await onPaypalReady().catch(()=>{});
      renderPaypalButtons(auth.currentUser);
      document.getElementById('paypal-button-container')
        .scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
    if (act === 'unsupported') {
      alert("Pro purchases are not available in your country yet. Please check back soon.");
      return;
    }

    if (act === 'country') {
      if (countrySelect) {
        countrySelect.focus();
        countrySelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }

    if (act === 'notify') {
      const user = auth.currentUser || null;
      if (!user) {
        // Should not happen because we gate notify by sign-in,
        // but guard just in case.
        alert("Please sign in with Google first, then try again.");
        return;
      }

      const email = getNotifyEmail(user);
      if (!email || !email.includes('@')) {
        alert("Please enter a valid email address so we can notify you.");
        if (notifyEmailInput) notifyEmailInput.focus();
        return;
      }

      const country = (typeof getBillingCountry === 'function')
        ? getBillingCountry()
        : null;
      const region  = (typeof getBillingRegion === 'function')
        ? getBillingRegion()
        : null;

      if (!country) {
        alert("Please select your country so we can log your request correctly.");
        if (countrySelect) countrySelect.focus();
        return;
      }

      // Disable button to prevent double-clicks
      ctaBtn.disabled = true;
      ctaBtn.textContent = "Savingâ€¦";

      try {
        const idToken = await user.getIdToken(/* forceRefresh */ true);

        const body = {
          email,
          country,
          region,
          reason: "blocked_billing_country_phase1",
          source: "pricing_page"
        };

        const resp = await fetch(LOG_INTEREST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`
          },
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          const text = await resp.text().catch(() => "");
          console.error("logPurchaseInterest failed", resp.status, text);
          alert("Sorry, we couldnâ€™t save your request right now. Please try again in a moment.");
          return;
        }

        console.log("[SCC pricing] Notify-me logged", { email, country, region });

        // Soft-lock the UI â€“ user has already been logged
        if (notifyEmailInput) {
          notifyEmailInput.readOnly = true;
        }
        if (notifyHint) {
          notifyHint.textContent = "Thanks! Weâ€™ll email you when Smart Column Cleaner Pro is available in your country.";
        }
        ctaBtn.textContent = "Saved";
        alert("Thanks! Weâ€™ll notify you when Pro is available in your country.");

      } catch (err) {
        console.error("notify â†’ logPurchaseInterest error", err);
        alert("Something went wrong while saving your request. Please try again.");
      } finally {
        // Re-enable button (even after success, in case you want further clicks)
        ctaBtn.disabled = false;
      }

      return;
    }

  };

  // Re-render PayPal buttons if Free & signed in when the plan selection changes
  document.addEventListener('change', async (ev) => {
    if (ev.target.name !== 'plan') return;
    const user = auth.currentUser;
    if (!user) return;
    const data = await fetchLicense(user);
    if (String(data.plan || 'free').toLowerCase() === 'free'){
      await onPaypalReady().catch(()=>{});
      renderPaypalButtons(user);
    }
  });
</script>
</body>
</html>
